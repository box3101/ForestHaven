---
import BaseLayout from "../../layouts/BaseLayout.astro";
import SubLayout from "../../layouts/SubLayout.astro";
import SubBody from "../../layouts/SubBody.astro";

const datph2 = "도시숲 소개";
const location = "둘러보기";
const pageTitle = `홈>${datph2}>${location}`;
const idName = "VirtualTour";

import "../../css/ui.css";

// 각 탭별 마커(시설) 데이터 - 전체 정보 포함
const tabFacilities = {
	"보전의 숲": [
		{
			id: "marker-1",
			title: "송도 솔밭 물빛누리공원",
			description:
				"송도송림 지역에 위치한 맨발학교는 최근 '맨발걷기 성지'로 주목받고 있는 송도솔녹지에 자리하고 있으며, 건강과 자연 치유를 테마로 한 활동 중심의 학교입니다.",
			images: [
				{ src: "../img/swiper_img01.png", alt: "송도 솔밭 물빛누리공원 1" },
				{ src: "../img/swiper_img02.png", alt: "송도 솔밭 물빛누리공원 2" },
				{ src: "../img/swiper_img03.png", alt: "송도 솔밭 물빛누리공원 3" },
			],
			hasRentalFacility: true, // 대관시설 여부
			link: "/facility/1",
		},
		{
			id: "marker-2",
			title: "내연산 치유의 숲",
			description:
				"내연산의 깊은 자연 속에서 심신의 안정을 찾을 수 있는 치유의 공간입니다. 맑은 공기와 아름다운 경관이 어우러진 힐링 명소입니다.",
			images: [
				{ src: "../img/swiper_img04.png", alt: "내연산 치유의 숲 1" },
				{ src: "../img/swiper_img01.png", alt: "내연산 치유의 숲 2" },
			],
			hasRentalFacility: false,
			link: "/facility/2",
		},
		{
			id: "marker-3",
			title: "생태학습원",
			description:
				"다양한 생태 체험 프로그램을 운영하는 교육 공간입니다. 어린이부터 성인까지 자연의 소중함을 배울 수 있습니다.",
			images: [
				{ src: "../img/swiper_img02.png", alt: "생태학습원 1" },
				{ src: "../img/swiper_img03.png", alt: "생태학습원 2" },
				{ src: "../img/swiper_img04.png", alt: "생태학습원 3" },
			],
			hasRentalFacility: true,
			link: "/facility/3",
		},
		{
			id: "marker-4",
			title: "숲속놀이터",
			description:
				"아이들이 자연 속에서 마음껏 뛰어놀 수 있는 친환경 놀이공간입니다. 안전하고 즐거운 놀이시설이 마련되어 있습니다.",
			images: [{ src: "../img/swiper_img01.png", alt: "숲속놀이터 1" }],
			hasRentalFacility: false,
			link: "/facility/4",
		},
	],
	"활력의 숲": [
		{
			id: "marker-5",
			title: "활력의 숲 시설 1",
			description: "활력 넘치는 활동을 위한 공간입니다.",
			images: [{ src: "../img/swiper_img02.png", alt: "활력의 숲 시설 1" }],
			hasRentalFacility: true,
			link: "/facility/5",
		},
		{
			id: "marker-6",
			title: "활력의 숲 시설 2",
			description: "운동과 건강을 위한 시설입니다.",
			images: [{ src: "../img/swiper_img03.png", alt: "활력의 숲 시설 2" }],
			hasRentalFacility: true,
			link: "/facility/6",
		},
		{
			id: "marker-7",
			title: "활력의 숲 시설 3",
			description: "자연 속 운동 공간입니다.",
			images: [{ src: "../img/swiper_img04.png", alt: "활력의 숲 시설 3" }],
			hasRentalFacility: false,
			link: "/facility/7",
		},
		{
			id: "marker-8",
			title: "활력의 숲 시설 4",
			description: "체력단련을 위한 최적의 장소입니다.",
			images: [{ src: "../img/swiper_img01.png", alt: "활력의 숲 시설 4" }],
			hasRentalFacility: true,
			link: "/facility/8",
		},
		{
			id: "marker-9",
			title: "활력의 숲 시설 5",
			description: "건강한 삶을 위한 공간입니다.",
			images: [{ src: "../img/swiper_img02.png", alt: "활력의 숲 시설 5" }],
			hasRentalFacility: false,
			link: "/facility/9",
		},
	],
	"소통의 숲": [
		{
			id: "marker-10",
			title: "소통의 숲 시설 1",
			description: "사람들과 소통하며 휴식할 수 있는 공간입니다.",
			images: [{ src: "../img/swiper_img03.png", alt: "소통의 숲 시설 1" }],
			hasRentalFacility: true,
			link: "/facility/10",
		},
		{
			id: "marker-11",
			title: "소통의 숲 시설 2",
			description: "자연 속에서 대화를 나눌 수 있는 장소입니다.",
			images: [{ src: "../img/swiper_img04.png", alt: "소통의 숲 시설 2" }],
			hasRentalFacility: false,
			link: "/facility/11",
		},
		{
			id: "marker-12",
			title: "소통의 숲 시설 3",
			description: "커뮤니티 활동을 위한 열린 공간입니다.",
			images: [{ src: "../img/swiper_img01.png", alt: "소통의 숲 시설 3" }],
			hasRentalFacility: true,
			link: "/facility/12",
		},
	],
	"마중의 숲": [
		{
			id: "marker-13",
			title: "마중의 숲 시설 1",
			description: "방문객을 맞이하는 첫 번째 공간입니다.",
			images: [{ src: "../img/swiper_img04.png", alt: "마중의 숲 시설 1" }],
			hasRentalFacility: false,
			link: "/facility/13",
		},
		{
			id: "marker-14",
			title: "마중의 숲 시설 2",
			description: "따뜻한 환영을 받을 수 있는 장소입니다.",
			images: [{ src: "../img/swiper_img01.png", alt: "마중의 숲 시설 2" }],
			hasRentalFacility: true,
			link: "/facility/14",
		},
		{
			id: "marker-15",
			title: "마중의 숲 시설 3",
			description: "편안한 휴식을 제공하는 공간입니다.",
			images: [{ src: "../img/swiper_img02.png", alt: "마중의 숲 시설 3" }],
			hasRentalFacility: true,
			link: "/facility/15",
		},
		{
			id: "marker-16",
			title: "마중의 숲 시설 4",
			description: "환영의 의미를 담은 특별한 공간입니다.",
			images: [{ src: "../img/swiper_img03.png", alt: "마중의 숲 시설 4" }],
			hasRentalFacility: false,
			link: "/facility/16",
		},
		{
			id: "marker-17",
			title: "마중의 숲 시설 5",
			description: "손님을 맞이하는 아름다운 정원입니다.",
			images: [{ src: "../img/swiper_img04.png", alt: "마중의 숲 시설 5" }],
			hasRentalFacility: true,
			link: "/facility/17",
		},
		{
			id: "marker-18",
			title: "마중의 숲 시설 6",
			description: "방문의 시작을 알리는 상징적인 장소입니다.",
			images: [{ src: "../img/swiper_img01.png", alt: "마중의 숲 시설 6" }],
			hasRentalFacility: false,
			link: "/facility/18",
		},
	],
};

// 각 탭별 식생 정보 (탭마다 고정)
const tabVegetation = {
	"보전의 숲": [
		{ icon: "../../img/icon-virtual-01.svg", text: "[교목]소나무: 12,000 (그루)" },
		{ icon: "../../img/icon-virtual-02.svg", text: "[교목]전나무: 450 (그루)" },
		{ icon: "../../img/icon-virtual-03.svg", text: "[초화류]맥문동: 3 (군락지)" },
		{ icon: "../../img/icon-virtual-04.svg", text: "[관목]철쭉: 1 (군락지)" },
		{ icon: "../../img/icon-virtual-05.svg", text: "[관목]개나리: 2 (군락지)" },
	],
	"활력의 숲": [
		{ icon: "../../img/icon-virtual-01.svg", text: "[교목]참나무: 8,000 (그루)" },
		{ icon: "../../img/icon-virtual-02.svg", text: "[교목]단풍나무: 300 (그루)" },
		{ icon: "../../img/icon-virtual-03.svg", text: "[초화류]산수국: 5 (군락지)" },
		{ icon: "../../img/icon-virtual-04.svg", text: "[관목]진달래: 2 (군락지)" },
		{ icon: "../../img/icon-virtual-05.svg", text: "[관목]병꽃나무: 1 (군락지)" },
	],
	"소통의 숲": [
		{ icon: "../../img/icon-virtual-01.svg", text: "[교목]느티나무: 5,000 (그루)" },
		{ icon: "../../img/icon-virtual-02.svg", text: "[교목]벚나무: 200 (그루)" },
		{ icon: "../../img/icon-virtual-03.svg", text: "[초화류]붓꽃: 8 (군락지)" },
		{ icon: "../../img/icon-virtual-04.svg", text: "[관목]회양목: 4 (군락지)" },
		{ icon: "../../img/icon-virtual-05.svg", text: "[관목]조팝나무: 3 (군락지)" },
	],
	"마중의 숲": [
		{ icon: "../../img/icon-virtual-01.svg", text: "[교목]은행나무: 3,000 (그루)" },
		{ icon: "../../img/icon-virtual-02.svg", text: "[교목]메타세쿼이아: 150 (그루)" },
		{ icon: "../../img/icon-virtual-03.svg", text: "[초화류]코스모스: 10 (군락지)" },
		{ icon: "../../img/icon-virtual-04.svg", text: "[관목]수수꽃다리: 6 (군락지)" },
		{ icon: "../../img/icon-virtual-05.svg", text: "[관목]명자나무: 4 (군락지)" },
	],
};

const virtualTourTabs = [
	{
		icon: "../../img/tab_img-01.svg",
		label: "보전의 숲",
		value: "보전의 숲",
		active: true,
		link: "#tabs1",
		content: {
			wrap01: {
				label: "Forest.01",
				img: "../../img/img-map-forest.png",
				icon: "../../img/img-compass.svg",
				markers: [
					{ id: "marker-1", left: "20%", top: "30%" },
					{ id: "marker-2", left: "45%", top: "25%" },
					{ id: "marker-3", left: "65%", top: "40%" },
					{ id: "marker-4", left: "35%", top: "60%" },
				],
			},
		},
	},
	{
		icon: "../../img/tab_img-02.svg",
		label: "활력의 숲",
		value: "활력의 숲",
		active: false,
		link: "#tabs2",
		content: {
			wrap01: {
				label: "Forest.02",
				img: "../../img/img-map-forest.png",
				icon: "../../img/img-compass.svg",
				markers: [
					{ id: "marker-5", left: "25%", top: "35%" },
					{ id: "marker-6", left: "50%", top: "30%" },
					{ id: "marker-7", left: "70%", top: "45%" },
					{ id: "marker-8", left: "40%", top: "65%" },
					{ id: "marker-9", left: "60%", top: "70%" },
				],
			},
		},
	},
	{
		icon: "../../img/tab_img-03.svg",
		label: "소통의 숲",
		value: "소통의 숲",
		active: false,
		link: "#tabs3",
		content: {
			wrap01: {
				label: "Forest.03",
				img: "../../img/img-map-forest.png",
				icon: "../../img/img-compass.svg",
				markers: [
					{ id: "marker-10", left: "30%", top: "40%" },
					{ id: "marker-11", left: "55%", top: "35%" },
					{ id: "marker-12", left: "75%", top: "55%" },
				],
			},
		},
	},
	{
		icon: "../../img/tab_img-04.svg",
		label: "마중의 숲",
		value: "마중의 숲",
		active: false,
		link: "#tabs4",
		content: {
			wrap01: {
				label: "Forest.04",
				img: "../../img/img-map-forest.png",
				icon: "../../img/img-compass.svg",
				markers: [
					{ id: "marker-13", left: "22%", top: "28%" },
					{ id: "marker-14", left: "48%", top: "33%" },
					{ id: "marker-15", left: "68%", top: "42%" },
					{ id: "marker-16", left: "38%", top: "58%" },
					{ id: "marker-17", left: "58%", top: "68%" },
					{ id: "marker-18", left: "78%", top: "75%" },
				],
			},
		},
	},
];
---

<BaseLayout pageTitle={pageTitle}>
	<SubLayout idName={idName} title={location} datph2={datph2}>
		<SubBody hideHead={false} title={location}>
			<div class="virtualTour-Tabs">
				<ul>
					{
						virtualTourTabs.map((tab) => (
							<li class={tab.active ? "active" : ""} data-tab={tab.value}>
								<a href={tab.link}>
									<img src={tab.icon} alt="" class="tab-icon" />
									<span>{tab.label}</span>
								</a>
							</li>
						))
					}
				</ul>
			</div>
			<div class="virtualTour-Contents">
				{
					virtualTourTabs.map((tab, tabIndex) => {
						const facilities = tabFacilities[tab.value] || [];
						const firstFacility = facilities[0];
						const vegetation = tabVegetation[tab.value] || [];

						return (
							<div
								class={`content ${tab.active ? "active" : ""}`}
								data-content={tab.value}
								data-tab-index={tabIndex}
							>
								<div class="wrap01">
									<span class="lable">{tab.content.wrap01.label}</span>
									<div class="map-container">
										<img class="map" src={tab.content.wrap01.img} alt="" />
										<div class="map-markers">
											{tab.content.wrap01.markers?.map((marker) => (
												<button
													class="map-marker"
													data-marker-id={marker.id}
													data-tab-index={tabIndex}
													style={`left: ${marker.left}; top: ${marker.top};`}
													aria-label={`마커 ${marker.id}`}
												>
													<span class="marker-icon" />
												</button>
											))}
										</div>
									</div>
									<img class="icon" src={tab.content.wrap01.icon} alt="" />
								</div>
								<div class="wrap02">
									<div class="left-wrap">
										<div class="title-wrap">
											<h2 class="section-title">숲 놀이터</h2>
											<a
												href={firstFacility?.link || "./info/GreenSpaceIntro.html"}
												class={`btn-list rental-facility-btn-${tabIndex}`}
												style={firstFacility?.hasRentalFacility ? "" : "display: none;"}
											>
												대관시설로 이동
											</a>
										</div>
										<div class="left" data-content-area={`content-${tabIndex}`}>
											<div class="swiper-container" id={`facilitySwiper-${tabIndex}`}>
												<div class="swiper-wrapper left-inner">
													{firstFacility?.images?.map((image, index) => (
														<div class="swiper-slide LFimage">
															<div class={`facility-card ${index === 0 ? "active" : ""}`}>
																<img src={image.src} alt={image.alt} loading="lazy" />
															</div>
														</div>
													))}
												</div>
											</div>
											<div class="text">
												<p class="description-text">{firstFacility?.description}</p>
											</div>
											<div class="custom-pagination type2">
												<hr class="hr-solid" />
												<div class={`swiper-pagination related-pagination-${tabIndex}`} />
												<div class="pagination-controls-wrapper">
													<div class="pagination-fraction">
														<span class={`current-slide current-slide-${tabIndex}`} />/
														<span class={`total-slides total-slides-${tabIndex}`}> </span>
													</div>
													<button
														class={`custom-prev-btn related-prev-${tabIndex}`}
														aria-label="이전"
													/>
													<button
														class={`autoplay-toggle autoplay-toggle-${tabIndex}`}
														aria-label="자동재생 토글"
													>
														<span class="pause-icon" />
													</button>
													<button
														class={`custom-next-btn related-next-${tabIndex}`}
														aria-label="다음"
													/>
												</div>
											</div>
										</div>
									</div>
									<div class="right-wrap" data-vegetation-area={`vegetation-${tabIndex}`}>
										<h2 class="section-title">식생 정보</h2>
										<div class="right-infoList">
											{vegetation.map((veg) => (
												<a class="right vegetation-item" href="">
													<div class="left-img">
														<img class="info-image" src={veg.icon} alt="" />
													</div>
													<div class="right-text">
														<p>{veg.text}</p>
													</div>
												</a>
											))}
										</div>
									</div>
								</div>
							</div>
						);
					})
				}
			</div>
		</SubBody>
	</SubLayout>
</BaseLayout>

<script is:inline define:vars={{ tabFacilities }}>
	const tabs = document.querySelectorAll(".virtualTour-Tabs li");
	const contents = document.querySelectorAll(".virtualTour-Contents .content");

	// 탭 클릭 이벤트
	tabs.forEach((tab) => {
		tab.addEventListener("click", function (e) {
			e.preventDefault();

			const tabValue = this.dataset.tab;

			// 모든 탭과 콘텐츠에서 active 제거
			tabs.forEach((t) => t.classList.remove("active"));
			contents.forEach((c) => c.classList.remove("active"));

			// 클릭된 탭과 해당 콘텐츠에 active 추가
			this.classList.add("active");
			const activeContent = document.querySelector(`[data-content="${tabValue}"]`);
			activeContent?.classList.add("active");

			// 활성화된 탭의 Swiper 업데이트
			if (activeContent) {
				const swiperContainer = activeContent.querySelector('[id^="facilitySwiper-"]');
				if (swiperContainer && swiperContainer.swiper) {
					setTimeout(() => {
						swiperContainer.swiper.update();
						const tabIndex = swiperContainer.id.split("-")[1];
						updatePaginationFraction(swiperContainer.swiper, tabIndex);
					}, 50);
				}
			}
		});
	});

	// 모든 Swiper 인스턴스 저장
	const swiperInstances = [];

	// Swiper 초기화 함수
	function initSwiper(containerId, tabIndex) {
		const swiperContainer = document.getElementById(containerId);

		if (!swiperContainer) {
			console.warn(`Swiper container ${containerId} not found`);
			return null;
		}

		// 이미 초기화되어 있으면 종료
		if (swiperContainer.swiper) {
			console.log(`Swiper ${containerId} already initialized`);
			return swiperContainer.swiper;
		}

		const swiper = new Swiper(`#${containerId}`, {
			spaceBetween: 32,
			loop: false,
			speed: 300,
			centeredSlides: false,
			grabCursor: true,
			watchSlidesProgress: true,
			observer: true,
			observeParents: true,

			autoplay: {
				delay: 3000,
				disableOnInteraction: false,
			},

			autoHeight: false,
			allowTouchMove: true,

			navigation: {
				nextEl: `.related-next-${tabIndex}`,
				prevEl: `.related-prev-${tabIndex}`,
				disabledClass: "swiper-button-disabled",
			},

			pagination: {
				el: `.related-pagination-${tabIndex}`,
				clickable: true,
				bulletClass: "swiper-pagination-bullet",
				bulletActiveClass: "swiper-pagination-bullet-active",
				type: "bullets",
				renderBullet: function (index, className) {
					return '<span class="' + className + '"></span>';
				},
			},

			breakpoints: {
				320: {
					slidesPerView: 1,
					spaceBetween: 0,
				},
				600: {
					slidesPerView: 2,
					spaceBetween: 32,
				},
			},

			on: {
				init: function () {
					console.log(`Swiper ${containerId} initialized`);
					updateActiveCard(this, tabIndex);
					updatePaginationFraction(this, tabIndex);

					const totalCards = this.slides.length;
					const visibleCards = this.params.slidesPerView;
					manageNavigationVisibility(this, totalCards, visibleCards, tabIndex);
				},
				slideChange: function () {
					updateActiveCard(this, tabIndex);
					updatePaginationFraction(this, tabIndex);
				},
				resize: function () {
					this.update();
					const totalCards = this.slides.length;
					const currentVisible = this.params.slidesPerView;
					manageNavigationVisibility(this, totalCards, currentVisible, tabIndex);
				},
			},
		});

		return swiper;
	}

	function manageNavigationVisibility(swiperInstance, total, visible, tabIndex) {
		const prevBtn = document.querySelector(`.related-prev-${tabIndex}`);
		const nextBtn = document.querySelector(`.related-next-${tabIndex}`);
		const pagination = document.querySelector(`.related-pagination-${tabIndex}`);

		if (total <= visible) {
			if (prevBtn) prevBtn.classList.add("navigation-hidden");
			if (nextBtn) nextBtn.classList.add("navigation-hidden");
			if (pagination) pagination.classList.add("pagination-hidden");
		} else {
			if (prevBtn) prevBtn.classList.remove("navigation-hidden");
			if (nextBtn) nextBtn.classList.remove("navigation-hidden");
			if (pagination) pagination.classList.remove("pagination-hidden");
		}
	}

	function updateActiveCard(swiperInstance, tabIndex) {
		const slides = swiperInstance.slides;
		slides.forEach(function (slide, index) {
			const card = slide.querySelector(".facility-card");
			if (card) {
				if (index === swiperInstance.activeIndex) {
					card.classList.add("active");
				} else {
					card.classList.remove("active");
				}
			}
		});
	}

	function updatePaginationFraction(swiperInstance, tabIndex) {
		const currentSlide = document.querySelector(`.current-slide-${tabIndex}`);
		const totalSlides = document.querySelector(`.total-slides-${tabIndex}`);

		if (currentSlide && totalSlides) {
			const total = swiperInstance.slides ? swiperInstance.slides.length : 0;
			const current = swiperInstance.activeIndex + 1;

			currentSlide.textContent = current;
			totalSlides.textContent = total;
		}
	}

	// 콘텐츠 업데이트 함수 (식생 정보 업데이트 제거, 대관시설 버튼 토글 추가)
	function updateFacilityContent(tabIndex, facilityData) {
		console.log("Updating content for tab:", tabIndex, "with data:", facilityData);

		const contentArea = document.querySelector(`[data-content-area="content-${tabIndex}"]`);

		if (!contentArea) {
			console.warn("Content area not found");
			return;
		}

		// 1. 텍스트 업데이트
		const descriptionText = contentArea.querySelector(".description-text");
		if (descriptionText) {
			descriptionText.textContent = facilityData.description;
		}

		// 2. 대관시설 버튼 표시/숨김
		const rentalButton = document.querySelector(`.rental-facility-btn-${tabIndex}`);
		if (rentalButton) {
			if (facilityData.hasRentalFacility) {
				rentalButton.style.display = "";
				rentalButton.href = facilityData.link || "./info/GreenSpaceIntro.html";
			} else {
				rentalButton.style.display = "none";
			}
		}

		// 3. Swiper 완전히 재생성
		const swiperContainer = document.getElementById(`facilitySwiper-${tabIndex}`);
		if (swiperContainer && swiperContainer.swiper) {
			const swiper = swiperContainer.swiper;

			// Swiper 파괴
			swiper.destroy(true, true);

			// 새로운 슬라이드 HTML 생성
			let slidesHTML = "";
			facilityData.images.forEach((image, index) => {
				slidesHTML += `
					<div class="swiper-slide LFimage">
						<div class="facility-card ${index === 0 ? "active" : ""}">
							<img src="${image.src}" alt="${image.alt}" loading="lazy" />
						</div>
					</div>
				`;
			});

			// swiper-wrapper 내용 교체
			const swiperWrapper = swiperContainer.querySelector(".swiper-wrapper");
			if (swiperWrapper) {
				swiperWrapper.innerHTML = slidesHTML;
			}

			// Swiper 재초기화
			setTimeout(() => {
				const newSwiper = initSwiper(`facilitySwiper-${tabIndex}`, tabIndex);

				// 인스턴스 배열 업데이트
				const instanceIndex = swiperInstances.findIndex(
					(s) => s && s.el && s.el.id === `facilitySwiper-${tabIndex}`
				);
				if (instanceIndex !== -1) {
					swiperInstances[instanceIndex] = newSwiper;
				}

				// 자동재생 토글 버튼 재설정
				const autoplayToggle = document.querySelector(`.autoplay-toggle-${tabIndex}`);
				if (autoplayToggle && newSwiper) {
					// 기존 이벤트 리스너 제거를 위해 복제
					const newToggle = autoplayToggle.cloneNode(true);
					autoplayToggle.parentNode.replaceChild(newToggle, autoplayToggle);

					newToggle.classList.add("playing");
					newToggle.addEventListener("click", function () {
						if (newSwiper.autoplay.running) {
							newSwiper.autoplay.stop();
							newToggle.classList.remove("playing");
							newToggle.classList.add("paused");
						} else {
							newSwiper.autoplay.start();
							newToggle.classList.remove("paused");
							newToggle.classList.add("playing");
						}
					});
				}
			}, 50);
		}
	}

	// 마커 클릭 이벤트 핸들러
	function initMarkerClickEvents() {
		const allMarkers = document.querySelectorAll(".map-marker");

		allMarkers.forEach((marker) => {
			marker.addEventListener("click", function (e) {
				e.preventDefault();

				const markerId = this.dataset.markerId;
				const tabIndex = parseInt(this.dataset.tabIndex);

				console.log("Marker clicked:", markerId, "Tab index:", tabIndex);

				// 현재 탭의 시설 데이터 가져오기
				const contentElement = document.querySelector(`[data-tab-index="${tabIndex}"]`);
				if (!contentElement) {
					console.warn("Content element not found");
					return;
				}

				const tabValue = contentElement.dataset.content;
				const facilities = tabFacilities[tabValue];

				if (!facilities) {
					console.warn("Facilities not found for tab:", tabValue);
					return;
				}

				// markerId와 일치하는 시설 데이터 찾기
				const facilityData = facilities.find((f) => f.id === markerId);

				if (!facilityData) {
					console.warn("Facility data not found for marker:", markerId);
					return;
				}

				// 콘텐츠 업데이트
				updateFacilityContent(tabIndex, facilityData);

				// 마커 active 상태 업데이트
				const sameTabMarkers = document.querySelectorAll(
					`.map-marker[data-tab-index="${tabIndex}"]`
				);
				sameTabMarkers.forEach((m) => m.classList.remove("active"));
				this.classList.add("active");

				console.log("Content updated successfully");
			});
		});
	}

	// 모든 Swiper 초기화
	function initAllSwipers() {
		const allSwiperContainers = document.querySelectorAll('[id^="facilitySwiper-"]');

		allSwiperContainers.forEach((container, index) => {
			const containerId = container.id;
			const tabIndex = containerId.split("-")[1];

			const swiper = initSwiper(containerId, tabIndex);
			if (swiper) {
				swiperInstances.push(swiper);

				// 자동재생 토글 버튼 설정
				const autoplayToggle = document.querySelector(`.autoplay-toggle-${tabIndex}`);
				if (autoplayToggle) {
					autoplayToggle.classList.add("playing");

					autoplayToggle.addEventListener("click", function () {
						if (swiper.autoplay.running) {
							swiper.autoplay.stop();
							autoplayToggle.classList.remove("playing");
							autoplayToggle.classList.add("paused");
						} else {
							swiper.autoplay.start();
							autoplayToggle.classList.remove("paused");
							autoplayToggle.classList.add("playing");
						}
					});
				}
			}
		});
	}

	// DOM 로드 완료 후 초기화
	function initWhenReady() {
		setTimeout(() => {
			initAllSwipers();
			initMarkerClickEvents();
		}, 100);
	}

	// DOM 로드 완료 후 초기화
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initWhenReady, { once: true });
	} else {
		initWhenReady();
	}
</script>
